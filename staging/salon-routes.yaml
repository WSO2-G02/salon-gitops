# =============================================================================
# Consolidated VirtualService for Staging Environment
# =============================================================================
# IMPORTANT: Route order matters! More specific routes MUST come before generic ones.
# The frontend catch-all route ("/") must be LAST.
#
# Path Mapping:
#   - /api/users/*        → user-service         /api/v1/*
#   - /api/appointments/* → appointment-service  /api/v1/*
#   - /api/services/*     → service-management   /api/v1/*
#   - /api/staff/*        → staff-management     /api/v1/*
#   - /api/notifications/*→ notification-service /api/v1/notifications/*
#   - /api/reports/*      → reports-analytics    /api/v1/analytics/*
#   - /*                  → frontend (catch-all, must be last)
# =============================================================================
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: salon-routes
  namespace: staging
spec:
  hosts:
  - "*"
  gateways:
  - istio-system/salon-gateway
  http:
  # ============================================
  # API Routes (must be before frontend catch-all)
  # ============================================
  
  # User Service API - /api/users/* → /api/v1/*
  - match:
    - uri:
        prefix: /api/users
    rewrite:
      uri: /api/v1
    route:
    - destination:
        host: user-service
        port:
          number: 80
  
  # Appointment Service API - /api/appointments/* → /api/v1/*
  - match:
    - uri:
        prefix: /api/appointments
    rewrite:
      uri: /api/v1
    route:
    - destination:
        host: appointment-service
        port:
          number: 80

  # Service Management API - /api/services/* → /api/v1/*
  - match:
    - uri:
        prefix: /api/services
    rewrite:
      uri: /api/v1
    route:
    - destination:
        host: service-management
        port:
          number: 80

  # Staff Management API - /api/staff/* → /api/v1/*
  - match:
    - uri:
        prefix: /api/staff
    rewrite:
      uri: /api/v1
    route:
    - destination:
        host: staff-management
        port:
          number: 80

  # Notification Service API - /api/notifications/* → /api/v1/notifications/*
  - match:
    - uri:
        prefix: /api/notifications
    rewrite:
      uri: /api/v1/notifications
    route:
    - destination:
        host: notification-service
        port:
          number: 80

  # Reports & Analytics API - /api/reports/* → /api/v1/analytics/*
  - match:
    - uri:
        prefix: /api/reports
    rewrite:
      uri: /api/v1/analytics
    route:
    - destination:
        host: reports-analytics
        port:
          number: 80

  # ============================================
  # Frontend Catch-All (MUST BE LAST)
  # ============================================
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend
        port:
          number: 80
