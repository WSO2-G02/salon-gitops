# =============================================================================
# Consolidated VirtualService for Staging Environment
# =============================================================================
# IMPORTANT: Route order matters! More specific routes MUST come before generic ones.
# The frontend catch-all route ("/") must be LAST.
#
# Path Mapping (frontend already includes /api/v1 in calls):
#   - /api/users/*        → user-service         (strip /api/users prefix)
#   - /api/appointments/* → appointment-service  (strip /api/appointments prefix)
#   - /api/services/*     → service-management   (strip /api/services prefix)
#   - /api/staff/*        → staff-management     (strip /api/staff prefix)
#   - /api/notifications/*→ notification-service (strip /api/notifications prefix)
#   - /api/reports/*      → reports-analytics    (strip /api/reports prefix)
#   - /*                  → frontend (catch-all, must be last)
#
# Example flow:
#   Frontend calls: https://aurora-glam.com/api/users/api/v1/login
#   VirtualService strips /api/users → /api/v1/login
#   Backend receives: /api/v1/login ✓
# =============================================================================
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: salon-routes
  namespace: staging
spec:
  hosts:
  - "staging.aurora-glam.com"  # Only handle staging subdomain
  gateways:
  - istio-system/salon-gateway
  http:
  # ============================================
  # API Routes (must be before frontend catch-all)
  # ============================================
  
  # User Service API - strip /api/users prefix, pass through to backend
  - match:
    - uri:
        prefix: /api/users/
    rewrite:
      uri: /
    route:
    - destination:
        host: user-service
        port:
          number: 80
  
  # Appointment Service API - strip /api/appointments prefix
  - match:
    - uri:
        prefix: /api/appointments/
    rewrite:
      uri: /
    route:
    - destination:
        host: appointment-service
        port:
          number: 80

  # Service Management API - strip /api/services prefix
  - match:
    - uri:
        prefix: /api/services/
    rewrite:
      uri: /
    route:
    - destination:
        host: service-management
        port:
          number: 80

  # Staff Management API - strip /api/staff prefix
  - match:
    - uri:
        prefix: /api/staff/
    rewrite:
      uri: /
    route:
    - destination:
        host: staff-management
        port:
          number: 80

  # Notification Service API - strip /api/notifications prefix
  - match:
    - uri:
        prefix: /api/notifications/
    rewrite:
      uri: /
    route:
    - destination:
        host: notification-service
        port:
          number: 80

  # Reports & Analytics API - strip /api/reports prefix
  - match:
    - uri:
        prefix: /api/reports/
    rewrite:
      uri: /
    route:
    - destination:
        host: reports-analytics
        port:
          number: 80

  # ============================================
  # Frontend Catch-All (MUST BE LAST)
  # ============================================
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: frontend
        port:
          number: 80
